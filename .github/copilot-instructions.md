# Copilot Instructions for Bolkiri Chatbot

## Overview
Bolkiri Chatbot is an AI-powered assistant for the Vietnamese restaurant Bolkiri. It provides customer support, menu recommendations, reservation management, and more. The project is built with the following technologies:

- **Backend**: FastAPI (Python)
- **Frontend**: React widget
- **AI**: OpenAI GPT-4
- **Database**: ChromaDB for knowledge base
- **Deployment**: Render.com

## Architecture
The project is divided into the following components:

1. **Backend**:
   - Located in the root directory.
   - Main entry point: `main.py`.
   - Core logic: `ai_agent.py` (AI agent implementation), `knowledge_base_enriched.py` (knowledge base management).
   - REST API built with FastAPI.

2. **Frontend**:
   - Located in the `frontend/` directory.
   - React-based chat widget for user interaction.

3. **Knowledge Base**:
   - JSON files like `bolkiri_knowledge_industrial_2025.json` store structured data.
   - Generated by `scraper_industrial_2025.py` which scrapes the website.
   - FAISS-based RAG for semantic search (via `rag_engine.py`).

4. **Deployment**:
   - Configured for Render.com.
   - Deployment scripts: `deploy_all.bat`, `deploy_to_github.bat`.

## CRITICAL: Architecture Principles

**L'architecture DOIT rester 100% RAG/Agentic :**

1. **Single Source of Truth** : La knowledge base (`bolkiri_knowledge_industrial_2025.json`)
   - Toutes les données (restaurants, menu, horaires, liens) proviennent du scraper
   - JAMAIS de données hardcodées dans le code ou les prompts

2. **RAG Flow** :
   ```
   User Query → RAG Search → Context Retrieval → LLM Generation → Response
   ```
   - Le contexte récupéré par RAG est LA source de vérité
   - Le LLM ne doit JAMAIS contredire le contexte
   - Pas de données hardcodées dans les prompts système

3. **Liens et URLs** :
   - Les liens sont injectés dans la KB par le scraper (format HTML `<a href="..." target="_blank">`)
   - Le LLM doit copier les liens TELS QUELS depuis le contexte
   - Ne JAMAIS lister des URLs en dur dans les prompts

4. **Validation** :
   - `_validate_response()` vérifie que la réponse ne contredit pas le contexte
   - Détection automatique des hallucinations (restaurants, horaires, prix)

5. **Update Flow** :
   ```
   Website Change → Scraper Run → KB Regeneration → FAISS Rebuild → Automatic Propagation
   ```
   - Aucune modification manuelle du code nécessaire pour mettre à jour les données

## Developer Workflows

### Setting Up the Backend
1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```
2. Create a `.env` file with the following variables:
   ```
   OPENAI_API_KEY=votre_clé_api
   WEBSITE_URL=https://bolkiri.fr
   ```
3. Start the backend server:
   ```bash
   python main.py
   ```

### Setting Up the Frontend
1. Navigate to the `frontend/` directory:
   ```bash
   cd frontend
   ```
2. Install dependencies:
   ```bash
   npm install
   ```
3. Start the frontend server:
   ```bash
   npm start
   ```

### Running Tests
- Backend tests are located in files like `test_rag.py` and `test_multilingual.py`.
- Run tests using:
  ```bash
  python -m unittest discover
  ```

### Deployment
- Follow instructions in `docs/DEPLOYMENT.md` for deploying to Render.com.

## Project-Specific Conventions

- **Architecture RAG/Agentic** :
  - JAMAIS de données hardcodées dans les prompts ou le code
  - Toutes les infos proviennent de la KB via RAG
  - Single source of truth : `bolkiri_knowledge_industrial_2025.json`

- **Knowledge Base Updates**:
  - Use `python scraper_industrial_2025.py` to refresh the knowledge base.
  - Auto-rebuild FAISS embeddings on deployment via `REBUILD_EMBEDDINGS` env var.

- **Error Handling**:
  - The AI agent raises `HTTPException` for uninitialized states (e.g., `agent is None`).

- **Logging**:
  - Use text-based logging: `[OK]`, `[WARN]`, `[ERROR]` (no emojis for Windows compatibility).

## Integration Points
- **OpenAI GPT-4**:
  - Integrated via `ai_agent.py`.
  - Requires `OPENAI_API_KEY`.
- **ChromaDB**:
  - Used for storing and querying the knowledge base.
- **Render.com**:
  - Deployment platform.

## Key Files and Directories
- `main.py`: Backend entry point.
- `ai_agent.py`: Core AI logic with validation system.
- `knowledge_base_enriched.py`: FAISS RAG wrapper with Bolkiri-specific methods.
- `rag_engine.py`: FAISS semantic search engine.
- `scraper_industrial_2025.py`: Web scraper for KB generation (JSON-LD + HTML parsing).
- `bolkiri_knowledge_industrial_2025.json`: Knowledge base (20 restaurants, ~32 menu items, 19 pages).
- `frontend/`: React-based chat widget.
- `static/index.html` & `docs/index.html`: Chat UIs with favicon.
- `requirements.txt`: Python dependencies.
- `runtime.txt`: Python version for Render (3.13).
- `Procfile`: Render deployment config.
- `.github/workflows/auto-scraping.yml`: Weekly scraping automation (Thursday 2am).

## Notes for AI Agents
- Ensure the `.env` file is correctly configured before running the backend.
- Refer to `README.md` and `docs/` for additional context.
- Follow the project structure and conventions to maintain consistency.
- Be concise, professional, and direct in all interactions.